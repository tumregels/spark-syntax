
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Section 1.4 - Decimals and Why did my Decimals Overflow Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Section 2 - Performing your First Transformations.html" />
    
    
    <link rel="prev" href="Section 1.3 - Maps and Dictionaries.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    README
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Chapter 1 - Basics
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Chapter 1 - Basics/Section 1 - Useful Material.html">
            
                <a href="../Chapter 1 - Basics/Section 1 - Useful Material.html">
            
                    
                    Section 1 - Useful Material
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Chapter 1 - Basics/Section 2 - Creating your First Data Object.html">
            
                <a href="../Chapter 1 - Basics/Section 2 - Creating your First Data Object.html">
            
                    
                    Section 2 - Creating your First Data Object
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Chapter 1 - Basics/Section 3 - Reading your First Dataset.html">
            
                <a href="../Chapter 1 - Basics/Section 3 - Reading your First Dataset.html">
            
                    
                    Section 3 - Reading your First Dataset
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Chapter 1 - Basics/Section 4 - More Comfortable with SQL.html">
            
                <a href="../Chapter 1 - Basics/Section 4 - More Comfortable with SQL.html">
            
                    
                    Section 4 - More Comfortable with SQL
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Chapter 2 - Exploring the Spark APIs
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="Section 1.1 - Struct Types.html">
            
                <a href="Section 1.1 - Struct Types.html">
            
                    
                    Section 1.1 - Struct Types
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="Section 1.2 - Arrays and Lists.html">
            
                <a href="Section 1.2 - Arrays and Lists.html">
            
                    
                    Section 1.2 - Arrays and Lists
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="Section 1.3 - Maps and Dictionaries.html">
            
                <a href="Section 1.3 - Maps and Dictionaries.html">
            
                    
                    Section 1.3 - Maps and Dictionaries
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.4" data-path="Section 1.4 - Decimals and Why did my Decimals Overflow.html">
            
                <a href="Section 1.4 - Decimals and Why did my Decimals Overflow.html">
            
                    
                    Section 1.4 - Decimals and Why did my Decimals Overflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="Section 2 - Performing your First Transformations.html">
            
                <a href="Section 2 - Performing your First Transformations.html">
            
                    
                    Section 2 - Performing your First Transformations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="Section 2.1 - Looking at Your Data.html">
            
                <a href="Section 2.1 - Looking at Your Data.html">
            
                    
                    Section 2.1 - Looking at Your Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="Section 2.2 - Selecting a Subset of Columns.html">
            
                <a href="Section 2.2 - Selecting a Subset of Columns.html">
            
                    
                    Section 2.2 - Selecting a Subset of Columns
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="Section 2.3 - Creating New Columns and Transforming Data.html">
            
                <a href="Section 2.3 - Creating New Columns and Transforming Data.html">
            
                    
                    Section 2.3 - Creating New Columns and Transforming Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="Section 2.4 - Constant Values and Column Expressions.html">
            
                <a href="Section 2.4 - Constant Values and Column Expressions.html">
            
                    
                    Section 2.4 - Constant Values and Column Expressions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="Section 2.5 - Casting Columns to Different Type.html">
            
                <a href="Section 2.5 - Casting Columns to Different Type.html">
            
                    
                    Section 2.5 - Casting Columns to Different Type
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.11" data-path="Section 2.6 - Filtering Data.html">
            
                <a href="Section 2.6 - Filtering Data.html">
            
                    
                    Section 2.6 - Filtering Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.12" data-path="Section 2.7 - Equality Statements in Spark and Comparison with Nulls.html">
            
                <a href="Section 2.7 - Equality Statements in Spark and Comparison with Nulls.html">
            
                    
                    Section 2.7 - Equality Statements in Spark and Comparison with Nulls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.13" data-path="Section 2.8 - Case Statements.html">
            
                <a href="Section 2.8 - Case Statements.html">
            
                    
                    Section 2.8 - Case Statements
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.14" data-path="Section 2.9 - Filling in Null Values.html">
            
                <a href="Section 2.9 - Filling in Null Values.html">
            
                    
                    Section 2.9 - Filling in Null Values
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.15" data-path="Section 2.10 - Spark Functions aren't Enough, I Need my Own!.html">
            
                <a href="Section 2.10 - Spark Functions aren't Enough, I Need my Own!.html">
            
                    
                    Section 2.10 - Spark Functions aren't Enough, I Need my Own!
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.16" data-path="Section 2.11  - Unionizing Multiple Dataframes.html">
            
                <a href="Section 2.11  - Unionizing Multiple Dataframes.html">
            
                    
                    Section 2.11  - Unionizing Multiple Dataframes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.17" data-path="Section 2.12 - Performing Joins <clean one>.html">
            
                <a href="Section 2.12 - Performing Joins <clean one>.html">
            
                    
                    Section 2.12 - Performing Joins 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.18" data-path="Section 3.1 - One to Many Rows.html">
            
                <a href="Section 3.1 - One to Many Rows.html">
            
                    
                    Section 3.1 - One to Many Rows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.19" data-path="Section 3.2 - Range Join Conditions <WIP>.html">
            
                <a href="Section 3.2 - Range Join Conditions <WIP>.html">
            
                    
                    Section 3.2 - Range Join Conditions 
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Chapter 3 - Aggregates
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../Chapter 3 - Aggregates/Section 1 - Clean Aggregations.html">
            
                <a href="../Chapter 3 - Aggregates/Section 1 - Clean Aggregations.html">
            
                    
                    Section 1 - Clean Aggregations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../Chapter 3 - Aggregates/Section 2 - Non Deterministic Ordering for GroupBys.html">
            
                <a href="../Chapter 3 - Aggregates/Section 2 - Non Deterministic Ordering for GroupBys.html">
            
                    
                    Section 2 - Non Deterministic Ordering for GroupBys
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Chapter 4 - Window Objects
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../Chapter 4 - Window Objects/Section 1 - Default Behaviour of a Window Object.html">
            
                <a href="../Chapter 4 - Window Objects/Section 1 - Default Behaviour of a Window Object.html">
            
                    
                    Section 1 - Default Behaviour of a Window Object
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../Chapter 4 - Window Objects/Section 2 - Ordering High Frequency Data with a Window Object.html">
            
                <a href="../Chapter 4 - Window Objects/Section 2 - Ordering High Frequency Data with a Window Object.html">
            
                    
                    Section 2 - Ordering High Frequency Data with a Window Object
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Chapter 6 - Tuning & Spark Parameters
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../Chapter 6 - Tuning & Spark Parameters/Section 1.1 - Understanding how Spark Works.html">
            
                <a href="../Chapter 6 - Tuning & Spark Parameters/Section 1.1 - Understanding how Spark Works.html">
            
                    
                    Section 1.1 - Understanding how Spark Works
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <span>
            
                    
                    Chapter 7 - High Performance Code
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../Chapter 7 - High Performance Code/Section 1.1 - Filter Pushdown.html">
            
                <a href="../Chapter 7 - High Performance Code/Section 1.1 - Filter Pushdown.html">
            
                    
                    Section 1.1 - Filter Pushdown
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../Chapter 7 - High Performance Code/Section 1.2 - Joins on Skewed Data <Null Keys>.html">
            
                <a href="../Chapter 7 - High Performance Code/Section 1.2 - Joins on Skewed Data <Null Keys>.html">
            
                    
                    Section 1.2 - Joins on Skewed Data 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../Chapter 7 - High Performance Code/Section 1.3 - Joins on Skewed Data <High Frequency Keys I>.html">
            
                <a href="../Chapter 7 - High Performance Code/Section 1.3 - Joins on Skewed Data <High Frequency Keys I>.html">
            
                    
                    Section 1.3 - Joins on Skewed Data 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../Chapter 7 - High Performance Code/Section 1.4 - Joins on Skewed Data <High Frequency Keys II> <WIP>.html">
            
                <a href="../Chapter 7 - High Performance Code/Section 1.4 - Joins on Skewed Data <High Frequency Keys II> <WIP>.html">
            
                    
                    Section 1.4 - Joins on Skewed Data  
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Section 1.4 - Decimals and Why did my Decimals Overflow</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h3 id="library-imports">Library Imports</h3>
<pre><code class="lang-python"><span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> SparkSession
<span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> types <span class="hljs-keyword">as</span> T

<span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> functions <span class="hljs-keyword">as</span> F

<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> decimal <span class="hljs-keyword">import</span> Decimal
</code></pre>
<h3 id="template">Template</h3>
<pre><code class="lang-python">spark = (
    SparkSession.builder
    .master(<span class="hljs-string">&quot;local&quot;</span>)
    .appName(<span class="hljs-string">&quot;Section 1.4 - Decimals and Why did my Decimals overflow&quot;</span>)
    .config(<span class="hljs-string">&quot;spark.some.config.option&quot;</span>, <span class="hljs-string">&quot;some-value&quot;</span>)
    .getOrCreate()
)

sc = spark.sparkContext

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_csv_schema</span><span class="hljs-params">(*args)</span>:</span>
    <span class="hljs-keyword">return</span> T.StructType([
        T.StructField(*arg)
        <span class="hljs-keyword">for</span> arg <span class="hljs-keyword">in</span> args
    ])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read_csv</span><span class="hljs-params">(fname, schema)</span>:</span>
    <span class="hljs-keyword">return</span> spark.read.csv(
        path=fname,
        header=<span class="hljs-keyword">True</span>,
        schema=get_csv_schema(*schema)
    )

<span class="hljs-keyword">import</span> os

data_path = <span class="hljs-string">&quot;/data/pets.csv&quot;</span>
base_path = os.path.dirname(os.getcwd())
path = base_path + data_path
</code></pre>
<h3 id="decimals-and-why-did-my-decimals-overflow">Decimals and Why did my Decimals overflow</h3>
<p>Some cases where you would deal with <code>Decimal</code> types are if you are talking about money, height, weight, etc. Working with <code>Decimal</code> types may appear simple at first but there are some nuances that will sneak up behind you. We will go through some ways to get around these as they are hard to debug.</p>
<p>Here is some simple jargon that we will use in the following examples:</p>
<ul>
<li><code>Integer</code>: The set of numbers including all the whole numbers and their opposites (the positive whole numbers, the negative whole numbers, and zero). ie. -1, 0, 1, 2, etc.</li>
<li><code>Irrational Number</code>: The set including all numbers that are non- terminating, non- repeating decimals. ie. 2.1, 10.5, etc.</li>
<li><code>Precision</code>: the maximum total number of digits.</li>
<li><code>Scale</code>: the number of digits on the right of dot.</li>
</ul>
<p>Source:</p>
<ul>
<li><a href="https://www.sparknotes.com/math/prealgebra/integersandrationals/terms/" target="_blank">link</a></li>
<li><a href="https://spark.apache.org/docs/latest/api/python/pyspark.sql.html#pyspark.sql.types.DecimalType" target="_blank">link</a></li>
</ul>
<h3 id="case-1-working-with-decimals-in-python">Case 1: Working With <code>Decimal</code>s in Python</h3>
<pre><code class="lang-python">print(<span class="hljs-string">&quot;Example 1 - {}&quot;</span>.format(Decimal(<span class="hljs-number">20</span>)))
print(<span class="hljs-string">&quot;Example 2 - {}&quot;</span>.format(Decimal(<span class="hljs-string">&quot;20.2&quot;</span>)))
print(<span class="hljs-string">&quot;Example 3 - {}&quot;</span>.format(Decimal(<span class="hljs-number">20.5</span>)))
print(<span class="hljs-string">&quot;Example 4 - {}&quot;</span>.format(Decimal(<span class="hljs-number">20.2</span>)))
</code></pre>
<pre><code>Example 1 - 20
Example 2 - 20.2
Example 3 - 20.5
Example 4 - 20.199999999999999289457264239899814128875732421875
</code></pre><p><strong>What Happened?</strong></p>
<p>Let&apos;s break down the examples above.</p>
<p>Example 1:</p>
<p>Here we provided a whole number, so nothing special.</p>
<p>Example 2:</p>
<p>Here we provided a string representing an irrational number. The <code>precision</code> and <code>scale</code> were preserved.</p>
<p>Example 3:</p>
<p>Here we provided an irrational number. The <code>precision</code> and <code>scale</code> were preserved.</p>
<p>Example 4:</p>
<p>Here we provided an irrational number, but this isn&apos;t what we expected? Well this is because it&apos;s impossible to provide an exact representation of <code>20.2</code> on the computer! If you want to know more about this you can look up &quot;IEEE floating point representation&quot;. We will keep this in mind for later on.</p>
<h3 id="ieee-floating-point-represenatation-out-of-scope-of-handbook">IEEE Floating Point Represenatation (OUT OF SCOPE OF HANDBOOK)</h3>
<p>When you were little have you ever tried to divide 10 by 3, did the result ever terminate? No. You were left with 3.33333... This is a similar case with trying to represent some <code>irrational numbers</code> on a computer.</p>
<blockquote>
<p>&quot;There&apos;s only 10 types of people in the world: those who get binary and those who don&apos;t.&quot;</p>
</blockquote>
<p>Let&apos;s think about how a computer works, if we go down to the lowest level, everything is stored as a binary value either a 0 or 1. Every whole number is easily representable, <code>11</code> is 3, <code>101</code> is 5, etc. But when it comes to <code>irrational numbers</code> there has been extensive work and established standards to representing these numbers most correctly. One of these standards are called the <code>IEEE-754 32-bit Single-Precision Floating-Point Numbers</code>.</p>
<p><strong>IEEE-754 32-bit Single-Precision Floating-Point Numbers</strong></p>
<p><img src="https://github.com/ericxiao251/spark-syntax/blob/master/src/images/ieee-floating-point-representation.png" alt=""></p>
<p>From the picture above we can see that to represent a single irrational or floating point number, you only have 32 bits (or 64 in other cases) and a set number of bits for each portion of the number. Only 1 bit is ever needed for the <code>signed</code> bit, then the number of bits will vary for the whole (exponent) number and then decimal fractional) values.</p>
<p>I won&apos;t show you how the whole number and floating point values are computed, you can refer to other references for this. For example, this is a very good example: <a href="https://www.youtube.com/watch?v=8afbTaA-gOQ" target="_blank">link</a>.</p>
<p>Let&apos;s look at our examples above:</p>
<table>
<thead>
<tr>
<th style="text-align:left">example</th>
<th style="text-align:right">signed</th>
<th style="text-align:right">exponent</th>
<th>fraction</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">20.2</td>
<td style="text-align:right">0</td>
<td style="text-align:right">010000011</td>
<td>01000011001100110011010</td>
</tr>
<tr>
<td style="text-align:left">20.5</td>
<td style="text-align:right">0</td>
<td style="text-align:right">010000011</td>
<td>01001000000000000000000</td>
</tr>
</tbody>
</table>
<p>If you did the calculations for <code>20.2</code> you will notice that the fraction portion never actually divides nicely. Like I mentioned with the simply example above with trying to divide 10 by 3 nicely, it&apos;s impoosible you will always have some leftover/remainder values. But with <code>20.5</code> we can see that it divides nicely.</p>
<h3 id="case-2-reading-in-decimals-in-spark-incorrectly">Case 2: Reading in Decimals in Spark (Incorrectly)</h3>
<pre><code class="lang-python">pets = read_csv(
    fname=path,
    schema=[
        (<span class="hljs-string">&quot;id&quot;</span>, T.LongType(), <span class="hljs-keyword">False</span>),
        (<span class="hljs-string">&quot;breed_id&quot;</span>, T.LongType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;nickname&quot;</span>, T.StringType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;birthday&quot;</span>, T.TimestampType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;age&quot;</span>, T.LongType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;color&quot;</span>, T.StringType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;weight&quot;</span>, T.DecimalType(), <span class="hljs-keyword">True</span>),
    ]
)
pets.show()
</code></pre>
<pre><code>+---+--------+--------+-------------------+---+-----+------+
| id|breed_id|nickname|           birthday|age|color|weight|
+---+--------+--------+-------------------+---+-----+------+
|  1|       1|    King|2014-11-22 12:30:31|  5|brown|    10|
|  2|       3|   Argus|2016-11-22 10:05:10| 10| null|     6|
|  3|       1|  Chewie|2016-11-22 10:05:10| 15| null|    12|
|  3|       2|   Maple|2018-11-22 10:05:10| 17|white|     3|
|  4|       2|    null|2019-01-01 10:05:10| 13| null|    10|
+---+--------+--------+-------------------+---+-----+------+
</code></pre><p><strong>What Happened?</strong></p>
<p>What happened to our <code>scalar</code> values, they weren&apos;t read in? This is because the default arguments to the <code>T.Decimal()</code> function are <code>DecimalType(precision=10, scale=0)</code>. So to read in the data correctly we need to override these default arguments.</p>
<h3 id="case-2-reading-in-decimals-in-spark-correctly">Case 2: Reading in Decimals in Spark (Correctly)</h3>
<pre><code class="lang-python">pets = read_csv(
    fname=path,
    schema=[
        (<span class="hljs-string">&quot;id&quot;</span>, T.LongType(), <span class="hljs-keyword">False</span>),
        (<span class="hljs-string">&quot;breed_id&quot;</span>, T.LongType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;nickname&quot;</span>, T.StringType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;birthday&quot;</span>, T.TimestampType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;age&quot;</span>, T.LongType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;color&quot;</span>, T.StringType(), <span class="hljs-keyword">True</span>),
        (<span class="hljs-string">&quot;weight&quot;</span>, T.DecimalType(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>), <span class="hljs-keyword">True</span>),
    ]
)
pets.show()
</code></pre>
<pre><code>+---+--------+--------+-------------------+---+-----+------+
| id|breed_id|nickname|           birthday|age|color|weight|
+---+--------+--------+-------------------+---+-----+------+
|  1|       1|    King|2014-11-22 12:30:31|  5|brown| 10.00|
|  2|       3|   Argus|2016-11-22 10:05:10| 10| null|  5.50|
|  3|       1|  Chewie|2016-11-22 10:05:10| 15| null| 12.00|
|  3|       2|   Maple|2018-11-22 10:05:10| 17|white|  3.40|
|  4|       2|    null|2019-01-01 10:05:10| 13| null| 10.00|
+---+--------+--------+-------------------+---+-----+------+
</code></pre><h3 id="case-3-reading-in-large-decimals-in-spark">Case 3: Reading in Large Decimals in Spark</h3>
<pre><code class="lang-python">spark.createDataFrame(
    data=[
        (<span class="hljs-number">100</span>,),
        (<span class="hljs-number">2</span> ** <span class="hljs-number">63</span>,)
    ],
    schema=[<span class="hljs-string">&apos;data&apos;</span>]
).show()
</code></pre>
<pre><code>+----+
|data|
+----+
| 100|
|null|
+----+
</code></pre><p><strong>What Happened?</strong></p>
<p>Why is the second value null? The second value overflows the max value of a decimal and never makes it to Spark (Scala). </p>
<p>If you see this error then you will need to check your input data as there might be something wrong there.</p>
<h3 id="case-3-setting-values-in-a-dataframe-incorrectly">Case 3: Setting Values in a DataFrame (Incorrectly)</h3>
<pre><code class="lang-python">(
    pets
    .withColumn(<span class="hljs-string">&apos;decimal_column&apos;</span>, F.lit(Decimal(<span class="hljs-number">20.2</span>)))
    .show()
)
</code></pre>
<pre><code>---------------------------------------------------------------------------

AnalysisException                         Traceback (most recent call last)

&lt;ipython-input-7-14e51ddcba87&gt; in &lt;module&gt;()
      1 (
      2     pets
----&gt; 3     .withColumn(&apos;decimal_column&apos;, F.lit(Decimal(20.2)))
      4     .show()
      5 )


/usr/local/lib/python2.7/site-packages/pyspark/sql/functions.pyc in _(col)
     40     def _(col):
     41         sc = SparkContext._active_spark_context
---&gt; 42         jc = getattr(sc._jvm.functions, name)(col._jc if isinstance(col, Column) else col)
     43         return Column(jc)
     44     _.__name__ = name


/usr/local/lib/python2.7/site-packages/py4j/java_gateway.pyc in __call__(self, *args)
   1255         answer = self.gateway_client.send_command(command)
   1256         return_value = get_return_value(
-&gt; 1257             answer, self.gateway_client, self.target_id, self.name)
   1258 
   1259         for temp_arg in temp_args:


/usr/local/lib/python2.7/site-packages/pyspark/sql/utils.pyc in deco(*a, **kw)
     67                                              e.java_exception.getStackTrace()))
     68             if s.startswith(&apos;org.apache.spark.sql.AnalysisException: &apos;):
---&gt; 69                 raise AnalysisException(s.split(&apos;: &apos;, 1)[1], stackTrace)
     70             if s.startswith(&apos;org.apache.spark.sql.catalyst.analysis&apos;):
     71                 raise AnalysisException(s.split(&apos;: &apos;, 1)[1], stackTrace)


AnalysisException: u&apos;DecimalType can only support precision up to 38;&apos;
</code></pre><p><strong>What Happened?</strong></p>
<p>Remember our python examples above? Well because the <code>precision</code> of the Spark <code>T.DecimalType</code> is 38 digits, the value went over the maximum value of the Spark type.</p>
<h3 id="case-3-setting-values-in-a-dataframe-correctly">Case 3: Setting Values in a DataFrame (Correctly)</h3>
<pre><code class="lang-python">(
    pets
    .withColumn(<span class="hljs-string">&apos;decimal_column&apos;</span>, F.lit(Decimal(<span class="hljs-string">&quot;20.2&quot;</span>)))
    .show()
)
</code></pre>
<pre><code>+---+--------+--------+-------------------+---+-----+------+--------------+
| id|breed_id|nickname|           birthday|age|color|weight|decimal_column|
+---+--------+--------+-------------------+---+-----+------+--------------+
|  1|       1|    King|2014-11-22 12:30:31|  5|brown| 10.00|          20.2|
|  2|       3|   Argus|2016-11-22 10:05:10| 10| null|  5.50|          20.2|
|  3|       1|  Chewie|2016-11-22 10:05:10| 15| null| 12.00|          20.2|
|  3|       2|   Maple|2018-11-22 10:05:10| 17|white|  3.40|          20.2|
|  4|       2|    null|2019-01-01 10:05:10| 13| null| 10.00|          20.2|
+---+--------+--------+-------------------+---+-----+------+--------------+
</code></pre><p><strong>What Happened?</strong></p>
<p>If we provide the irrational number as a string, this solves the problem.</p>
<h3 id="case-4-performing-arthimetrics-with-decimaltypes-incorrectly">Case 4: Performing Arthimetrics with <code>DecimalType</code>s (Incorrectly)</h3>
<pre><code class="lang-python">pets = spark.createDataFrame(
    data=[
        (Decimal(<span class="hljs-string">&apos;113.790000000000000000&apos;</span>), Decimal(<span class="hljs-string">&apos;2.54&apos;</span>)),
        (Decimal(<span class="hljs-string">&apos;113.790000000000000000&apos;</span>), Decimal(<span class="hljs-string">&apos;2.54&apos;</span>)),
    ],
    schema=[<span class="hljs-string">&apos;weight_in_kgs&apos;</span>,<span class="hljs-string">&apos;conversion_to_lbs&apos;</span>]
)

pets.show()
</code></pre>
<pre><code>+--------------------+--------------------+
|       weight_in_kgs|   conversion_to_lbs|
+--------------------+--------------------+
|113.7900000000000...|2.540000000000000000|
|113.7900000000000...|2.540000000000000000|
+--------------------+--------------------+
</code></pre><pre><code class="lang-python">(
    pets
    .withColumn(<span class="hljs-string">&apos;weight_in_lbs&apos;</span>, F.col(<span class="hljs-string">&apos;weight_in_kgs&apos;</span>) * F.col(<span class="hljs-string">&apos;conversion_to_lbs&apos;</span>))
    .show()
)
</code></pre>
<pre><code>+--------------------+--------------------+-------------+
|       weight_in_kgs|   conversion_to_lbs|weight_in_lbs|
+--------------------+--------------------+-------------+
|113.7900000000000...|2.540000000000000000|   289.026600|
|113.7900000000000...|2.540000000000000000|   289.026600|
+--------------------+--------------------+-------------+
</code></pre><p><strong>What Happened?</strong></p>
<p>This used to overflow... Guess they updated it &#x1F605;.</p>
<h3 id="case-4-performing-arthimetrics-operations-with-decimaltypes-correctly">Case 4: Performing Arthimetrics Operations with DecimalTypes (Correctly)</h3>
<pre><code class="lang-python">(
    pets
    .withColumn(<span class="hljs-string">&apos;weight_in_kgs&apos;</span>, F.col(<span class="hljs-string">&apos;weight_in_kgs&apos;</span>).cast(<span class="hljs-string">&apos;Decimal(20,2)&apos;</span>))
    .withColumn(<span class="hljs-string">&apos;conversion_to_lbs&apos;</span>, F.col(<span class="hljs-string">&apos;conversion_to_lbs&apos;</span>).cast(<span class="hljs-string">&apos;Decimal(20,2)&apos;</span>))
    .withColumn(<span class="hljs-string">&apos;weight_in_lbs&apos;</span>, F.col(<span class="hljs-string">&apos;weight_in_kgs&apos;</span>) * F.col(<span class="hljs-string">&apos;conversion_to_lbs&apos;</span>))
    .show()
)
</code></pre>
<pre><code>+-------------+-----------------+-------------+
|weight_in_kgs|conversion_to_lbs|weight_in_lbs|
+-------------+-----------------+-------------+
|       113.79|             2.54|     289.0266|
|       113.79|             2.54|     289.0266|
+-------------+-----------------+-------------+
</code></pre><p><strong>What Happened?</strong></p>
<p>Before doing the calculations, we truncated (with the help of the <code>cast</code> function, which we will learn about in the later chapters) all of the values to be only 2 <code>scalar</code> digits at most. This is how you should perform your arithmetic operations with <code>Decimal Types</code>. Ideally you should know the minimum number of <code>scalar</code> digits needed for each datatype.</p>
<h3 id="summary">Summary</h3>
<ul>
<li>We learned that you should always initial <code>Decimal</code> types using string represented numbers, if they are an Irrational Number.</li>
<li>When reading in <code>Decimal</code> types, you should explicitly override the default arguments of the Spark type and make sure that the underlying data is correct.</li>
<li>When performing arithmetic operations with decimal types you should always truncate the scalar digits to the lowest number of digits as possible, if you haven&apos;t already.</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Section 1.3 - Maps and Dictionaries.html" class="navigation navigation-prev " aria-label="Previous page: Section 1.3 - Maps and Dictionaries">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Section 2 - Performing your First Transformations.html" class="navigation navigation-next " aria-label="Next page: Section 2 - Performing your First Transformations">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Section 1.4 - Decimals and Why did my Decimals Overflow","level":"1.3.4","depth":2,"next":{"title":"Section 2 - Performing your First Transformations","level":"1.3.5","depth":2,"path":"Chapter 2 - Exploring the Spark APIs/Section 2 - Performing your First Transformations.md","ref":"Chapter 2 - Exploring the Spark APIs/Section 2 - Performing your First Transformations.md","articles":[]},"previous":{"title":"Section 1.3 - Maps and Dictionaries","level":"1.3.3","depth":2,"path":"Chapter 2 - Exploring the Spark APIs/Section 1.3 - Maps and Dictionaries.md","ref":"Chapter 2 - Exploring the Spark APIs/Section 1.3 - Maps and Dictionaries.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","katex@1.1.3","edit-link@2.0.x","github@2.0.x"],"root":"./src","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"edit-link":{"label":"Edit","base":"https://github.com/ericxiao251/spark-syntax/edit/master"},"github":{"url":"https://github.com/ericxiao251/spark-syntax"},"katex":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":14,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"toc":true},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"3.2.x"},"file":{"path":"Chapter 2 - Exploring the Spark APIs/Section 1.4 - Decimals and Why did my Decimals Overflow.md","mtime":"2019-03-21T01:55:34.981Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-03-21T01:55:40.233Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

